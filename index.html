<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<title>SOLEC ¬∑ Panel Mario</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;600;700&family=Barlow+Condensed:wght@700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --negro:#0d0d0d; --rojo:#cc1a1a; --amarillo:#f5c800;
    --bg:#f2f1ee; --surface:#fff; --surface2:#f7f6f3; --border:#e0ddd6;
    --text:#1a1a1a; --text2:#6f6a64;
  }
  *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
  body{font-family:Barlow,sans-serif;background:var(--bg);color:var(--text);padding-bottom:80px}
  header{position:sticky;top:0;z-index:50;background:var(--negro);border-bottom:3px solid transparent;
    border-image:linear-gradient(90deg,var(--rojo),var(--amarillo)) 1}
  .hwrap{display:flex;gap:12px;align-items:center;padding:12px 16px}
  .mark{width:42px;height:42px;border-radius:50%;background:var(--rojo);display:flex;align-items:center;justify-content:center;
    box-shadow:0 0 0 2px var(--amarillo);font-size:20px}
  .htxt h1{font-family:"Barlow Condensed";font-size:20px;letter-spacing:.08em;color:#fff;line-height:1}
  .htxt h1 span{color:var(--amarillo)}
  .htxt p{font-size:10px;color:#ffffff88;letter-spacing:.12em;text-transform:uppercase;margin-top:2px}
  .wrap{max-width:560px;margin:0 auto;padding:16px;display:flex;flex-direction:column;gap:14px}
  .card{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.06)}
  .chead{background:var(--negro);padding:10px 14px;color:#fff;display:flex;align-items:center;justify-content:space-between}
  .chead .t{font-family:"Barlow Condensed";font-size:14px;letter-spacing:.06em;text-transform:uppercase}
  .cbody{padding:14px;display:flex;flex-direction:column;gap:12px}
  label{font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.1em}
  input,select,textarea{width:100%;background:var(--surface2);border:1.5px solid var(--border);border-radius:10px;
    padding:12px 12px;font-size:16px;outline:none}
  input:focus,select:focus,textarea:focus{border-color:var(--rojo);background:#fff}
  textarea{height:90px;resize:none}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .pillrow{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .pill{border:2px solid var(--border);background:var(--surface2);border-radius:12px;padding:12px 10px;text-align:center;
    font-weight:700;color:var(--text2);cursor:pointer}
  .pill.active{border-color:var(--rojo);background:#fff2f2;color:var(--rojo)}
  .cats{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .cat{border:1px solid var(--border);background:var(--surface2);border-radius:12px;padding:12px;cursor:pointer}
  .cat strong{display:block}
  .cat small{color:var(--text2)}
  .cat.active{border-color:var(--rojo);background:#fff}
  .btn{border:none;border-radius:12px;padding:16px;font-family:"Barlow Condensed";font-size:18px;font-weight:800;
    letter-spacing:.08em;text-transform:uppercase;cursor:pointer}
  .btn.primary{background:var(--rojo);color:#fff;box-shadow:0 4px 16px rgba(204,26,26,.25)}
  .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
  .hint{font-size:12px;color:var(--text2);font-style:italic}
  .ok{background:#eaf7ef;border:1px solid #bfe7cd;color:#1a7a3c;padding:10px 12px;border-radius:10px;font-size:13px;display:none}
  .err{background:#fff2f2;border:1px solid #f0b9b9;color:#b31212;padding:10px 12px;border-radius:10px;font-size:13px;display:none}
</style>
</head>
<body>
<header>
  <div class="hwrap">
    <div class="mark">‚ö°</div>
    <div class="htxt">
      <h1>SOL<span>EC</span>¬Æ</h1>
      <p>Panel t√©cnico ¬∑ Registro de trabajo</p>
    </div>
  </div>
</header>

<div class="wrap">

  <div class="card">
    <div class="chead"><div class="t">1 ¬∑ Fecha y horario</div></div>
    <div class="cbody">
      <div class="row2">
        <div>
          <label>Fecha</label>
          <input type="date" id="fecha">
        </div>
        <div>
          <label>ID del registro (auto)</label>
          <input type="text" id="rid" readonly>
        </div>
      </div>
      <div class="row2">
        <div>
          <label>Hora inicio</label>
          <input type="time" id="hin">
        </div>
        <div>
          <label>Hora fin</label>
          <input type="time" id="hfin">
        </div>
      </div>
      <div class="hint">Tip: si no carg√°s horas, pod√©s completar al final antes de enviar.</div>
    </div>
  </div>

  <div class="card">
    <div class="chead"><div class="t">2 ¬∑ Edificio</div></div>
    <div class="cbody">
      <div>
        <label>Edificio</label>
        <input type="text" id="edificio" placeholder="Ej: Tonina 5 ¬∑ Calle 123">
      </div>
      <div class="hint">Por ahora es texto libre. Despu√©s lo conectamos con tu listado.</div>
    </div>
  </div>

  <div class="card">
    <div class="chead"><div class="t">3 ¬∑ Tipo de visita</div></div>
    <div class="cbody">
      <div class="pillrow">
        <div class="pill" onclick="setTipo(this,'Preventivo/Abono')">üìã Preventivo</div>
        <div class="pill" onclick="setTipo(this,'Reclamo')">üîß Reclamo</div>
        <div class="pill" onclick="setTipo(this,'Urgencia')">üö® Urgencia</div>
        <div class="pill" onclick="setTipo(this,'Trabajo puntual')">üìù Puntual</div>
      </div>

      <div class="row2">
        <div>
          <label>Fuera de horario</label>
          <select id="fueraHorario">
            <option value="">‚Äî</option>
            <option>Si</option>
            <option>No</option>
          </select>
        </div>
        <div>
          <label>Horas extra (n√∫mero)</label>
          <input type="text" id="horasExtra" placeholder="0">
        </div>
      </div>

      <div id="tipoErr" class="err">Eleg√≠ un tipo de visita.</div>
    </div>
  </div>

  <div class="card">
    <div class="chead"><div class="t">4 ¬∑ Trabajos (resumen para Ciro)</div></div>
    <div class="cbody">
      <label>Categor√≠a principal (marc√° una o varias)</label>
      <div class="cats">
        <div class="cat" onclick="toggleCat(this,'Iluminaci√≥n')"><strong>üí° Iluminaci√≥n</strong><small>Luz y control</small></div>
        <div class="cat" onclick="toggleCat(this,'Bombas')"><strong>üö∞ Bombas</strong><small>El√©ctrico bombas</small></div>
        <div class="cat" onclick="toggleCat(this,'Seguridad')"><strong>üì° Seguridad</strong><small>C√°maras/portero</small></div>
        <div class="cat" onclick="toggleCat(this,'Energ√≠a/Tableros')"><strong>‚ö° Energ√≠a</strong><small>Protecciones</small></div>
      </div>

      <div>
        <label>Trabajos estructurados (uno por l√≠nea)</label>
        <textarea id="trabajos" placeholder="Ej:
- Reemplazo 5 dicroicas en hall PB
- Cambio autom√°tico de pasillo piso 3
- Ajuste fotoc√©lula exterior"></textarea>
      </div>

      <div>
        <label>Notas libres (solo si hace falta)</label>
        <textarea id="notaLibre" placeholder="Ej: acceso complejo / artefacto muy sucio / requiere soporte extra..."></textarea>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="chead"><div class="t">5 ¬∑ Materiales (resumen)</div></div>
    <div class="cbody">
      <div>
        <label>Materiales (uno por l√≠nea, con cantidad)</label>
        <textarea id="materiales" placeholder="Ej:
- Dicroica GU10 7W fr√≠a x5
- Autom√°tico pasillo x1
- Precintos x10"></textarea>
      </div>
      <div class="hint">Despu√©s lo hacemos con stock camioneta/dep√≥sito. Hoy lo dejamos registrable.</div>
    </div>
  </div>

  <div id="ok" class="ok">‚úÖ Enviado. Ya aparece en Ciro como ‚ÄúPara revisar‚Äù.</div>
  <div id="err" class="err">‚ö†Ô∏è Error enviando. Revis√° internet e intent√° de nuevo.</div>

  <button class="btn primary" onclick="enviar()">ENVIAR REGISTRO</button>
  <button class="btn ghost" onclick="limpiar()">LIMPIAR FORMULARIO</button>

</div>

<script>
const SHEETDB_URL = "https://sheetdb.io/api/v1/pqo4oljkpi6dj";
let tipoVisita = "";
let cats = new Set();

function pad2(n){ return String(n).padStart(2,'0'); }
function genId(){
  const d = new Date();
  const ts = `${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}-${pad2(d.getHours())}${pad2(d.getMinutes())}${pad2(d.getSeconds())}`;
  const rnd = Math.random().toString(16).slice(2,8).toUpperCase();
  return `SO-${ts}-${rnd}`;
}

function initDefaults(){
  document.getElementById("rid").value = genId();
  const d = new Date();
  document.getElementById("fecha").value = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  document.getElementById("hin").value = `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
initDefaults();

function setTipo(el, val){
  tipoVisita = val;
  document.querySelectorAll(".pill").forEach(p=>p.classList.remove("active"));
  el.classList.add("active");
  document.getElementById("tipoErr").style.display = "none";
}

function toggleCat(el, val){
  if(cats.has(val)){ cats.delete(val); el.classList.remove("active"); }
  else { cats.add(val); el.classList.add("active"); }
}

function linesToPipe(txt){
  return (txt||"")
    .split("\n")
    .map(s=>s.replace(/^\s*[-‚Ä¢]\s*/,'').trim())
    .filter(Boolean)
    .join(" | ");
}

async function enviar(){
  const rid = document.getElementById("rid").value.trim();
  const fecha = document.getElementById("fecha").value.trim();
  const hin = document.getElementById("hin").value.trim();
  const hfin = document.getElementById("hfin").value.trim();
  const edificio = document.getElementById("edificio").value.trim();

  if(!tipoVisita){
    document.getElementById("tipoErr").style.display = "block";
    return;
  }
  if(!edificio){
    document.getElementById("err").style.display="block";
    document.getElementById("err").textContent="‚ö†Ô∏è Falta edificio.";
    return;
  }

  const trabajosPipe = linesToPipe(document.getElementById("trabajos").value);
  const notaLibre = document.getElementById("notaLibre").value.trim();
  const materialesPipe = linesToPipe(document.getElementById("materiales").value);

  const fueraHorario = document.getElementById("fueraHorario").value || "";
  const horasExtra = document.getElementById("horasExtra").value.trim() || "";

  const catStr = Array.from(cats).join(" | ");

  const payload = {
    data: {
      "ID": rid,
      "Fecha": fecha,
      "Hora Inicio": hin,
      "Hora Fin": hfin,
      "Edificio": edificio,
      "Tipo de Visita": tipoVisita,
      "Categorias": catStr,

      "Trabajos Estructurados": trabajosPipe,
      "Trabajos Libres": notaLibre,

      "Materiales Estructurados": materialesPipe,
      "Materiales Libres": "",

      "Urgencia Fuera Horario": (tipoVisita==="Urgencia" ? (fueraHorario==="Si" ? "S√≠" : "No") : ""),
      "Horas Extra": horasExtra,

      "Estado": "Pendiente",
      "Nota Dueno": "",

      "Total MO": "",
      "Total MAT": "",
      "Total": "",
      "Resumen ARCA": ""
    }
  };

  document.getElementById("ok").style.display="none";
  document.getElementById("err").style.display="none";

  try{
    const res = await fetch(SHEETDB_URL + "?sheet=Registros", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    if(!res.ok) throw new Error("HTTP "+res.status);

    document.getElementById("ok").style.display="block";
    limpiar(false);
    document.getElementById("rid").value = genId();
  }catch(e){
    console.error(e);
    document.getElementById("err").style.display="block";
    document.getElementById("err").textContent="‚ö†Ô∏è Error enviando. Revis√° internet e intent√° de nuevo.";
  }
}

function limpiar(resetId=true){
  document.getElementById("edificio").value="";
  document.getElementById("trabajos").value="";
  document.getElementById("notaLibre").value="";
  document.getElementById("materiales").value="";
  document.getElementById("fueraHorario").value="";
  document.getElementById("horasExtra").value="";

  tipoVisita="";
  document.querySelectorAll(".pill").forEach(p=>p.classList.remove("active"));

  cats = new Set();
  document.querySelectorAll(".cat").forEach(c=>c.classList.remove("active"));

  if(resetId) document.getElementById("rid").value = genId();
}
</script>
</body>
</html>
